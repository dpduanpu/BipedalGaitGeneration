(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     84162,       1731]
NotebookOptionsPosition[     81946,       1681]
NotebookOutlinePosition[     82313,       1697]
CellTagsIndexPosition[     82270,       1694]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{"(*", "\n", 
  RowBox[{
   RowBox[{"CoreDynamicAlgorithms", ".", 
    RowBox[{"nb", ":", " ", 
     RowBox[{
     "An", " ", "implementation", " ", "of", " ", "the", " ", "RNEA", " ", 
      "algorithm", "\n", "and", " ", "its", " ", 
      RowBox[{"derivative", ".", "\n", "Copyright"}], " ", 
      RowBox[{"(", "C", ")"}], " ", "2017", " ", "Nelson", " ", "Rosa", " ", 
      RowBox[{"Jr", ".", "\n", "\n", "This"}], " ", "program", " ", "is", " ",
       "free", " ", "software"}], ":", " ", 
     RowBox[{"you", " ", "can", " ", "redistribute", " ", "it", " ", 
      RowBox[{"and", "/", "or"}], " ", "modify", "\n", "it", " ", "under", 
      " ", "the", " ", "terms", " ", "of", " ", "the", " ", "GNU", " ", 
      "General", " ", "Public", " ", "License", " ", "as", " ", "published", 
      " ", "by", "\n", 
      RowBox[{"the", " ", "Free", " ", "Software", " ", "Foundation"}]}]}]}], 
   ",", " ", 
   RowBox[{
   "either", " ", "version", " ", "3", " ", "of", " ", "the", " ", 
    "License"}], ",", " ", 
   RowBox[{"or", "\n", 
    RowBox[{"(", 
     RowBox[{"at", " ", "your", " ", "option"}], ")"}], " ", "any", " ", 
    "later", " ", 
    RowBox[{"version", ".", " ", "This"}], " ", "program", " ", "is", " ", 
    "distributed", " ", "in", " ", "the", " ", "\n", "hope", " ", "that", " ",
     "it", " ", "will", " ", "be", " ", "useful"}], ",", " ", 
   RowBox[{
    RowBox[{"but", " ", "WITHOUT", " ", "ANY", " ", "WARRANTY"}], ";", " ", 
    RowBox[{
    "without", " ", "even", " ", "the", " ", "\n", "implied", " ", "warranty",
      " ", "of", " ", "MERCHANTABILITY", " ", "or", " ", "FITNESS", " ", 
     "FOR", " ", "A", " ", "PARTICULAR", " ", 
     RowBox[{"PURPOSE", ".", "\n", "See"}], " ", "the", " ", "GNU", " ", 
     "General", " ", "Public", " ", "License", " ", "for", " ", "more", " ", 
     RowBox[{"details", ".", " ", "You"}], " ", "should", " ", "have", " ", 
     "\n", "received", " ", "a", " ", "copy", " ", "of", " ", "the", " ", 
     "GNU", " ", "General", " ", "Public", " ", "License", " ", "along", " ", 
     "with", " ", "this", " ", 
     RowBox[{"program", ".", "\n", "If"}], " ", "not"}]}], ",", " ", 
   RowBox[{
    RowBox[{"see", " ", "<", 
     RowBox[{"http", ":"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"www", ".", "gnu", ".", "org"}], "/", "licenses"}], "/"}], ">",
      "."}]}]}], "\n", "*)"}]], "Code",
 InitializationCell->True,
 CellChangeTimes->{{3.6103707836964283`*^9, 3.610370783709448*^9}, {
  3.610370828952024*^9, 3.610370962648698*^9}, {3.6103710877518406`*^9, 
  3.610371111376195*^9}, {3.6103711469392376`*^9, 3.6103712325731497`*^9}, {
  3.610371305900334*^9, 3.610371331708816*^9}, {3.610371368620943*^9, 
  3.61037139802861*^9}, {3.6103715538125486`*^9, 3.6103716079966354`*^9}, {
  3.717206562929199*^9, 3.7172065683823853`*^9}},
 CellLabel->"In[13]:=",ExpressionUUID->"59f5aa58-c7ae-458c-ae67-8abe32970981"],

Cell[CellGroupData[{

Cell["Begin Package", "Section",
 CellChangeTimes->{{3.5914870039053636`*^9, 
  3.591487004222381*^9}},ExpressionUUID->"04ab2fc5-9b64-4da9-9a70-\
e61022bce381"],

Cell[BoxData[{
 RowBox[{"BeginPackage", "[", 
  RowBox[{"\"\<RigidBodyDynamics`\>\"", ",", " ", 
   RowBox[{"{", 
    RowBox[{"\"\<GlobalVariables`\>\"", ",", " ", "\"\<Derivatives`\>\""}], 
    "}"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{
  3.5844197483839703`*^9, {3.5844250604318256`*^9, 3.5844250721475377`*^9}, {
   3.5844251233785*^9, 3.5844251234877005`*^9}, {3.5844253988774505`*^9, 
   3.5844254390946617`*^9}, {3.5844254919948354`*^9, 3.5844254990149255`*^9}, 
   3.584425543397398*^9, {3.584425574800518*^9, 3.584425581945394*^9}, {
   3.5844256737523947`*^9, 3.5844257230957055`*^9}, {3.5844279668250203`*^9, 
   3.5844279860756264`*^9}, {3.584428374816189*^9, 3.584428378919037*^9}, {
   3.5914865865694637`*^9, 3.591486626255737*^9}, {3.5914867823906765`*^9, 
   3.5914867827646985`*^9}, {3.591486817520689*^9, 3.5914868205858636`*^9}, {
   3.591486965884186*^9, 3.5914869664642324`*^9}, {3.5915022447717495`*^9, 
   3.5915022459698176`*^9}, {3.591542902441803*^9, 3.591542929051241*^9}, {
   3.59154329988008*^9, 3.591543327692632*^9}, 3.5915439898189273`*^9, {
   3.5915443331789765`*^9, 3.5915443348977413`*^9}, {3.591544409656703*^9, 
   3.591544412687962*^9}, {3.591721260928192*^9, 3.591721326772053*^9}, {
   3.5922422663532963`*^9, 3.592242267056429*^9}, {3.5922818277082567`*^9, 
   3.59228183637475*^9}, {3.593367625062662*^9, 3.5933676251720285`*^9}, 
   3.717720222842661*^9, {3.71772975341938*^9, 3.7177297933885107`*^9}, {
   3.71773268682224*^9, 3.7177326901660385`*^9}, {3.7178703942700653`*^9, 
   3.717870395504458*^9}, {3.717870444301779*^9, 3.7178704457549343`*^9}, 
   3.71889625843709*^9, {3.769871416878792*^9, 3.7698714239407754`*^9}, {
   3.769881767312684*^9, 
   3.7698817680157804`*^9}},ExpressionUUID->"d87f4dd9-db65-4e30-b098-\
18ed02ae01d7"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "RBDSaveDynamics", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<D\>\"", " ", "\[Rule]", " ", "Automatic"}], ",", " ", 
      RowBox[{"\"\<F\>\"", " ", "\[Rule]", " ", "Automatic"}]}], "}"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDSaveDynamics", "[", 
    RowBox[{"rbd_", ",", " ", "n_", ",", " ", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"dir", ",", " ", "fil"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"fil", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<F\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"fil", " ", "===", " ", "Automatic"}], ",", " ", 
        RowBox[{
         RowBox[{"fil", " ", "=", " ", "\"\<CompiledFunctions\>\""}], ";"}]}],
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"dir", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<D\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"dir", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"dir", " ", "===", " ", "Automatic"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"NotebookDirectory", "[", "]"}], ",", " ", "fil"}], "}"}], 
         ",", " ", 
         RowBox[{"{", 
          RowBox[{"dir", ",", " ", "fil"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"dir", " ", "=", " ", 
       RowBox[{"FileNameJoin", "@", 
        RowBox[{"Flatten", "@", "dir"}]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{"DirectoryQ", "[", "dir", "]"}]}], ",", " ", 
        RowBox[{
         RowBox[{"CreateDirectory", "[", "dir", "]"}], ";"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Export", "[", 
       RowBox[{
        RowBox[{"FileNameJoin", "[", 
         RowBox[{"{", 
          RowBox[{"dir", ",", " ", 
           RowBox[{"\"\<rbd-\>\"", " ", "<>", " ", 
            RowBox[{"ToString", "[", "n", "]"}], " ", "<>", " ", 
            "\"\<.mx\>\""}]}], "}"}], "]"}], ",", " ", "rbd"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.68230374796873*^9, 3.6823038850645137`*^9}, {
   3.6823039332157774`*^9, 3.682304023743485*^9}, {3.6823040932059317`*^9, 
   3.6823040955238647`*^9}, {3.68230413737066*^9, 3.6823043573533688`*^9}, {
   3.6823044104740105`*^9, 3.682304451696723*^9}, {3.68230449771941*^9, 
   3.6823046318034334`*^9}, {3.6823046657472277`*^9, 3.682304704196093*^9}, {
   3.682304734915185*^9, 3.6823048658987856`*^9}, {3.6823049439762864`*^9, 
   3.6823050026212187`*^9}, {3.6823050404927206`*^9, 
   3.6823050410362597`*^9}, {3.6823050752365556`*^9, 
   3.6823050955272393`*^9}, {3.6823051342124767`*^9, 
   3.6823052517374477`*^9}, {3.682305285988165*^9, 3.6823053350795727`*^9}, {
   3.6823054001920905`*^9, 3.682305409329131*^9}, {3.682305444605262*^9, 
   3.6823054447724295`*^9}, {3.682305695391763*^9, 3.6823057109654493`*^9}, {
   3.6823057811154203`*^9, 3.682305798385718*^9}, {3.6823058589421062`*^9, 
   3.68230587678259*^9}, {3.682305917540344*^9, 3.682305947132357*^9}, {
   3.6823059795600324`*^9, 3.682306031830327*^9}, 3.682306082511269*^9, 
   3.682306128268832*^9, {3.6823061920149813`*^9, 3.68230624640162*^9}, {
   3.68230632345162*^9, 3.68230632735818*^9}, {3.6823063711743727`*^9, 
   3.6823063714499235`*^9}, {3.682306418785074*^9, 3.682306478604681*^9}, {
   3.6823065185704546`*^9, 3.682306552284587*^9}, {3.682306607782626*^9, 
   3.6823066683250413`*^9}, {3.682306733680232*^9, 3.6823068039099827`*^9}, 
   3.682306867095252*^9, {3.682382989195298*^9, 3.682382989648425*^9}, {
   3.6846786502507315`*^9, 3.684678713126303*^9}, 3.6846787492203846`*^9, {
   3.6846827406372185`*^9, 3.684682742050202*^9}, {3.6971954176051965`*^9, 
   3.69719541958959*^9}, {3.7416869880195217`*^9, 3.7416870023424277`*^9}, {
   3.741687056276157*^9, 3.741687076087185*^9}, 3.741687114053254*^9, {
   3.741687256017664*^9, 3.7416872735164175`*^9}, {3.741687307639009*^9, 
   3.741687313372959*^9}, {3.741691216693403*^9, 3.741691219818181*^9}, {
   3.7416914385057287`*^9, 3.7416914433334804`*^9}, {3.7416915757303295`*^9, 
   3.741691594682108*^9}, {3.741691727017902*^9, 3.741691909629919*^9}, {
   3.74169194836158*^9, 3.741691998686107*^9}, {3.7416920633982763`*^9, 
   3.7416920797252274`*^9}, {3.7416921402209387`*^9, 
   3.7416921674846263`*^9}, {3.741692209153561*^9, 3.741692218621632*^9}, {
   3.741692329238752*^9, 3.7416923715013733`*^9}, {3.7416924284858584`*^9, 
   3.7416924717015195`*^9}, {3.7416943306990633`*^9, 3.741694353884853*^9}, {
   3.741694465720667*^9, 3.741694470798417*^9}, {3.741694691017151*^9, 
   3.741694702547567*^9}, {3.7416969654653025`*^9, 3.741697059521053*^9}, 
   3.741697128299363*^9, {3.7416972252993903`*^9, 3.7416972290647144`*^9}, {
   3.7416979956505594`*^9, 3.7416980101495295`*^9}, {3.7416987887369394`*^9, 
   3.741698791361755*^9}, {3.7416988302027397`*^9, 3.7416988382802916`*^9}, {
   3.7416988729340897`*^9, 3.7416989094314833`*^9}, {3.74169940786493*^9, 
   3.7416994091295977`*^9}, {3.7416994762634764`*^9, 
   3.7416994824870615`*^9}, {3.7416996480445232`*^9, 
   3.7416996510348268`*^9}, {3.7416997733479776`*^9, 
   3.7416997895741415`*^9}, {3.769746124496422*^9, 3.769746129833372*^9}, {
   3.769870166211364*^9, 3.769870203720849*^9}, {3.769870320888359*^9, 
   3.769870324903686*^9}, {3.7698703950475426`*^9, 3.769870395391261*^9}, {
   3.769870428857557*^9, 3.7698704482936316`*^9}, {3.769870520759839*^9, 
   3.769870521806637*^9}, {3.76987134704158*^9, 3.7698713666539354`*^9}, 
   3.7698718161948905`*^9, {3.7698719890869665`*^9, 3.7698719989924893`*^9}, {
   3.7698720693293433`*^9, 3.7698720828439784`*^9}, {3.7698723039607964`*^9, 
   3.7698723198606973`*^9}, {3.7698723733040276`*^9, 3.769872419889798*^9}, {
   3.769872574110004*^9, 3.769872634523028*^9}, {3.7698727841344957`*^9, 
   3.769872784462595*^9}, {3.769872822782642*^9, 3.769872872781989*^9}, 
   3.7698729129196568`*^9, {3.769873165353579*^9, 3.7698731786182275`*^9}, {
   3.76987321924835*^9, 3.769873226987026*^9}, 3.7698732603595605`*^9, {
   3.7698733161367188`*^9, 3.769873323176648*^9}, {3.769874720469761*^9, 
   3.7698747242339244`*^9}, {3.769875602093328*^9, 3.7698756299146852`*^9}, {
   3.769875900075269*^9, 3.769875938802208*^9}, {3.7698817173191347`*^9, 
   3.7698817272527437`*^9}, {3.777507177348958*^9, 3.777507183542984*^9}, {
   3.7775089478252773`*^9, 3.777508948189043*^9}, {3.7997165270078993`*^9, 
   3.799716528702415*^9}, {3.799763056145114*^9, 3.799763072576921*^9}, 
   3.799763122192893*^9, {3.799763156523831*^9, 
   3.7997631614610643`*^9}},ExpressionUUID->"7f674f35-5bdb-4c7a-a973-\
7a869a2c8730"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "RBDLoadDynamics", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<D\>\"", " ", "\[Rule]", " ", "Automatic"}], ",", " ", 
      RowBox[{"\"\<F\>\"", " ", "\[Rule]", " ", "Automatic"}]}], "}"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDLoadDynamics", "::", "dir"}], " ", "=", " ", 
    "\"\<`` does not exist.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDLoadDynamics", "[", 
    RowBox[{"n_", ",", " ", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "rbd", ",", " ", "lib", ",", " ", "dir", ",", " ", "fil", ",", " ", 
       "d"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"fil", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<F\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"fil", " ", "===", " ", "Automatic"}], ",", " ", 
        RowBox[{
         RowBox[{"fil", " ", "=", " ", "\"\<CompiledFunctions\>\""}], ";"}]}],
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"dir", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<D\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"dir", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"dir", " ", "===", " ", "Automatic"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"NotebookDirectory", "[", "]"}], ",", " ", "fil"}], "}"}], 
         ",", " ", 
         RowBox[{"{", 
          RowBox[{"dir", ",", " ", "fil"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"dir", " ", "=", " ", 
       RowBox[{"FileNameJoin", "@", 
        RowBox[{"Flatten", "@", "dir"}]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{"DirectoryQ", "[", "dir", "]"}]}], ",", " ", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{
           RowBox[{"RBDLoadDynamics", "::", "dir"}], ",", " ", "dir"}], "]"}],
          ";", " ", "\[IndentingNewLine]", 
         RowBox[{"Return", "[", "$Failed", "]"}], ";"}]}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"Import", "[", 
       RowBox[{"FileNameJoin", "[", 
        RowBox[{"{", 
         RowBox[{"dir", ",", " ", 
          RowBox[{"\"\<rbd-\>\"", " ", "<>", " ", 
           RowBox[{"ToString", "[", "n", "]"}], " ", "<>", " ", 
           "\"\<.mx\>\""}]}], "}"}], "]"}], "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.68230374796873*^9, 3.6823038850645137`*^9}, {
   3.6823039332157774`*^9, 3.682304023743485*^9}, {3.6823040932059317`*^9, 
   3.6823040955238647`*^9}, {3.68230413737066*^9, 3.6823043573533688`*^9}, {
   3.6823044104740105`*^9, 3.682304451696723*^9}, {3.68230449771941*^9, 
   3.6823046318034334`*^9}, {3.6823046657472277`*^9, 3.682304704196093*^9}, {
   3.682304734915185*^9, 3.6823048658987856`*^9}, {3.6823049439762864`*^9, 
   3.6823050026212187`*^9}, {3.6823050404927206`*^9, 
   3.6823050410362597`*^9}, {3.6823050752365556`*^9, 
   3.6823050955272393`*^9}, {3.6823051342124767`*^9, 
   3.6823052517374477`*^9}, {3.682305285988165*^9, 3.6823053350795727`*^9}, {
   3.6823054001920905`*^9, 3.682305409329131*^9}, {3.682305444605262*^9, 
   3.6823054447724295`*^9}, {3.682305695391763*^9, 3.6823057109654493`*^9}, {
   3.6823057811154203`*^9, 3.682305798385718*^9}, {3.6823058589421062`*^9, 
   3.68230587678259*^9}, {3.682305917540344*^9, 3.682305947132357*^9}, {
   3.6823059795600324`*^9, 3.682306031830327*^9}, 3.682306082511269*^9, 
   3.682306128268832*^9, {3.6823061920149813`*^9, 3.68230624640162*^9}, {
   3.68230632345162*^9, 3.68230632735818*^9}, {3.6823063711743727`*^9, 
   3.6823063714499235`*^9}, {3.682306418785074*^9, 3.682306478604681*^9}, {
   3.6823065185704546`*^9, 3.682306552284587*^9}, {3.682306607782626*^9, 
   3.6823066683250413`*^9}, {3.682306733680232*^9, 3.6823068039099827`*^9}, 
   3.682306867095252*^9, {3.682382989195298*^9, 3.682382989648425*^9}, {
   3.6846786502507315`*^9, 3.684678713126303*^9}, 3.6846787492203846`*^9, {
   3.6846827406372185`*^9, 3.684682742050202*^9}, {3.6971954176051965`*^9, 
   3.69719541958959*^9}, {3.7416869880195217`*^9, 3.7416870023424277`*^9}, {
   3.741687056276157*^9, 3.741687076087185*^9}, 3.741687114053254*^9, {
   3.741687256017664*^9, 3.7416872735164175`*^9}, {3.741687307639009*^9, 
   3.741687313372959*^9}, {3.741691216693403*^9, 3.741691219818181*^9}, {
   3.7416914385057287`*^9, 3.7416914433334804`*^9}, {3.7416915757303295`*^9, 
   3.741691594682108*^9}, {3.741691727017902*^9, 3.741691909629919*^9}, {
   3.74169194836158*^9, 3.741691998686107*^9}, {3.7416920633982763`*^9, 
   3.7416920797252274`*^9}, {3.7416921402209387`*^9, 
   3.7416921674846263`*^9}, {3.741692209153561*^9, 3.741692218621632*^9}, {
   3.741692329238752*^9, 3.7416923715013733`*^9}, {3.7416924284858584`*^9, 
   3.7416924717015195`*^9}, {3.7416943306990633`*^9, 3.741694353884853*^9}, {
   3.741694465720667*^9, 3.741694470798417*^9}, {3.741694691017151*^9, 
   3.741694702547567*^9}, {3.7416969654653025`*^9, 3.741697059521053*^9}, 
   3.741697128299363*^9, {3.7416972252993903`*^9, 3.7416972290647144`*^9}, {
   3.7416979956505594`*^9, 3.7416980101495295`*^9}, {3.7416987887369394`*^9, 
   3.741698791361755*^9}, {3.7416988302027397`*^9, 3.7416988382802916`*^9}, {
   3.7416988729340897`*^9, 3.7416989094314833`*^9}, {3.74169940786493*^9, 
   3.7416994091295977`*^9}, {3.7416994762634764`*^9, 
   3.7416994824870615`*^9}, {3.7416996480445232`*^9, 
   3.7416996510348268`*^9}, {3.7416997733479776`*^9, 
   3.7416997895741415`*^9}, {3.769746124496422*^9, 3.769746129833372*^9}, {
   3.769870166211364*^9, 3.769870203720849*^9}, {3.769870320888359*^9, 
   3.769870324903686*^9}, {3.7698703950475426`*^9, 3.769870395391261*^9}, {
   3.769870428857557*^9, 3.7698704482936316`*^9}, {3.769870520759839*^9, 
   3.769870521806637*^9}, {3.76987134704158*^9, 3.7698713666539354`*^9}, 
   3.7698718161948905`*^9, {3.7698719890869665`*^9, 3.7698719989924893`*^9}, {
   3.7698720693293433`*^9, 3.7698720828439784`*^9}, {3.7698723039607964`*^9, 
   3.7698723198606973`*^9}, {3.7698723733040276`*^9, 3.769872419889798*^9}, {
   3.769872574110004*^9, 3.769872634523028*^9}, {3.7698727841344957`*^9, 
   3.769872784462595*^9}, {3.769872822782642*^9, 3.7698730028945384`*^9}, {
   3.7698730888552413`*^9, 3.7698731095256467`*^9}, {3.769873284232808*^9, 
   3.7698732929665623`*^9}, 3.7698733326126523`*^9, {3.769873414653507*^9, 
   3.769873428524458*^9}, {3.7698734675840907`*^9, 3.769873562890753*^9}, {
   3.7698736436797123`*^9, 3.76987364422657*^9}, {3.7698736987850657`*^9, 
   3.769873752668187*^9}, {3.769873783275301*^9, 3.769873787743738*^9}, {
   3.7698738810140743`*^9, 3.769873884779438*^9}, {3.769873928336331*^9, 
   3.7698739289612913`*^9}, {3.769874079430562*^9, 3.769874085601984*^9}, {
   3.7698741645157137`*^9, 3.7698741816238127`*^9}, {3.769874233632105*^9, 
   3.7698742389441977`*^9}, {3.76987439602255*^9, 3.7698744083341455`*^9}, {
   3.7698744447412*^9, 3.7698744519438114`*^9}, {3.7698744918158865`*^9, 
   3.7698745083771772`*^9}, {3.7698745547997684`*^9, 
   3.7698745950155683`*^9}, {3.769874639334153*^9, 3.7698746489427757`*^9}, {
   3.7698746930020623`*^9, 3.7698747783194113`*^9}, {3.7698748571396074`*^9, 
   3.769874863529781*^9}, {3.769874960464303*^9, 3.7698750262139473`*^9}, {
   3.769875126360791*^9, 3.7698751473740606`*^9}, {3.7698756635059643`*^9, 
   3.7698756875510745`*^9}, {3.7698760865952554`*^9, 3.7698761101872787`*^9}, 
   3.7698791331768646`*^9, {3.7698817564853673`*^9, 3.7698817609069204`*^9}, {
   3.7698826772968397`*^9, 3.769882686030527*^9}, {3.7997165446466703`*^9, 
   3.799716545451337*^9}, {3.7997631057598963`*^9, 3.799763124187004*^9}, 
   3.799763163413909*^9},ExpressionUUID->"49cfc31d-69f0-4f2b-9ad5-\
76cfe8f18c5c"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Expanded inputs for Compile", "Section",
 CellChangeTimes->{{3.5914870039053636`*^9, 3.591487004222381*^9}, {
  3.71883572760752*^9, 
  3.718835733654455*^9}},ExpressionUUID->"8278f024-1335-4385-9af0-\
6f7198297bb9"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"CompileArgs", ",", " ", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"CompileArgs", "[", 
    RowBox[{"v_", ",", " ", "n_", ",", " ", 
     RowBox[{"list_:", "True"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "a", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"Thread", "/@", 
        RowBox[{"Thread", "[", 
         RowBox[{"\[FormalP]", "@", "v"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"a", "\[LeftDoubleBracket]", 
        RowBox[{"All", ",", " ", 
         RowBox[{"2", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", "=", " ", 
       RowBox[{
        RowBox[{"a", "\[LeftDoubleBracket]", 
         RowBox[{"All", ",", " ", 
          RowBox[{"2", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", "/.", 
        " ", 
        RowBox[{
         RowBox[{"\[FormalP]", "[", "a_", "]"}], " ", "\[RuleDelayed]", " ", 
         "a"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{"list", ",", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"a", "\[LeftDoubleBracket]", 
           RowBox[{"All", ",", " ", "3"}], "\[RightDoubleBracket]"}], " ", 
          "=", " ", 
          RowBox[{
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"IntegerQ", "[", "#", "]"}], ",", " ", "1", ",", " ", 
              RowBox[{"Length", "@", "#"}]}], "]"}], "&"}], " ", "/@", " ", 
           RowBox[{"a", "\[LeftDoubleBracket]", 
            RowBox[{"All", ",", " ", "3"}], "\[RightDoubleBracket]"}]}]}], 
         ";"}]}], "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"wrap", " ", "args", " ", "in", " ", "Hold"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"CreateSymbol", "[", 
           RowBox[{
            RowBox[{"Evaluate", "@", 
             RowBox[{
             "i", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], 
            ",", " ", "j", ",", " ", "Hold"}], "]"}], ",", " ", 
          RowBox[{"i", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}],
           ",", " ", 
          RowBox[{
           RowBox[{
           "i", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}], "+", 
           "j"}]}], "}"}], ",", " ", "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"i", ",", " ", "a"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"j", ",", " ", "0", ",", " ", "n"}], "}"}]}], 
       "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.7177296735436068`*^9, 3.7177296912937737`*^9}, {
   3.7177298616391597`*^9, 3.7177298629516706`*^9}, {3.7177301058914866`*^9, 
   3.7177301158603096`*^9}, 3.7177302024236317`*^9, {3.71773033565929*^9, 
   3.717730432050831*^9}, {3.7177304852075853`*^9, 3.717730565739585*^9}, {
   3.7177306449903536`*^9, 3.717730645552842*^9}, {3.7177307205848174`*^9, 
   3.717730724147369*^9}, {3.717730767897772*^9, 3.7177307858666925`*^9}, {
   3.7177312271365066`*^9, 3.7177313247311883`*^9}, {3.7177313735441537`*^9, 
   3.7177313863724*^9}, {3.717731426513401*^9, 3.7177314525605288`*^9}, {
   3.717731508264168*^9, 3.7177315104204364`*^9}, {3.717731577030445*^9, 
   3.7177316718126097`*^9}, 3.717731744078925*^9, {3.71773232927197*^9, 
   3.7177323388033085`*^9}, {3.717732382850604*^9, 3.717732386303777*^9}, {
   3.717732421147854*^9, 3.717732450679385*^9}, {3.717732621602872*^9, 
   3.71773262932171*^9}, {3.7177326651189113`*^9, 3.7177326694470935`*^9}, 
   3.717732703900545*^9, 3.717732735994599*^9, 3.7177328174797506`*^9, {
   3.717759039271948*^9, 3.7177590423500967`*^9}, {3.717772283055875*^9, 
   3.7177723198218613`*^9}, {3.717772660184458*^9, 3.7177726836690683`*^9}, {
   3.717773127735793*^9, 3.7177732248460855`*^9}, {3.7177732698933897`*^9, 
   3.7177733324564877`*^9}, {3.717773545599121*^9, 3.7177736019590344`*^9}, {
   3.717773674022219*^9, 3.7177736825222993`*^9}, {3.717773832258112*^9, 
   3.717773832773727*^9}, {3.7177738785398026`*^9, 3.7177739237902336`*^9}, {
   3.7177739688687816`*^9, 3.717774129839051*^9}, {3.7177742379182005`*^9, 
   3.717774239355732*^9}, {3.7177743397160597`*^9, 3.717774523624055*^9}, {
   3.7177745711401353`*^9, 3.7177745877965393`*^9}, {3.7177746277031674`*^9, 
   3.7177746424220624`*^9}, {3.7177746925162725`*^9, 3.71777470625079*^9}, {
   3.7177747874703107`*^9, 3.717774848252143*^9}, {3.7177749175809226`*^9, 
   3.7177749847690616`*^9}, 3.7177750478477755`*^9, {3.7183822307591133`*^9, 
   3.7183822327747583`*^9}, {3.718385974372997*^9, 3.718385974576111*^9}},
 CellLabel->"In[22]:=",ExpressionUUID->"a8e7d36b-be75-452d-852f-ddcaacdf720b"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Compile Expressions of Pure Functions", "Section",
 CellChangeTimes->{{3.5914870039053636`*^9, 3.591487004222381*^9}, {
  3.7188357364669695`*^9, 
  3.718835743545165*^9}},ExpressionUUID->"3d54113b-9519-4a08-b31d-\
5f7e1a407f10"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{"RBDCompileExpression", ",", " ", "HoldRest"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDCompileExpression", "[", 
     RowBox[{"F_Association", ",", " ", 
      RowBox[{"n_:", "0"}], ",", " ", 
      RowBox[{"o", ":", 
       RowBox[{"OptionsPattern", "[", "Compile", "]"}]}]}], "]"}], " ", ":=", 
    " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"f", ",", " ", "v", ",", " ", "c"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "add", " ", "relevant", " ", "variable", " ", "to", " ", "depth"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"v", " ", "=", " ", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"v_Symbol", ",", " ", "i_Integer"}], "}"}], " ", 
         "\[RuleDelayed]", " ", 
         RowBox[{"depth", "[", 
          RowBox[{"v", ",", " ", "i", ",", " ", "n"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{
         RowBox[{"Hold", "[", "\"\<O\>\"", "]"}], "/.", " ", "F"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"f", " ", "=!=", " ", 
           RowBox[{"Hold", "[", "\"\<O\>\"", "]"}]}], " ", "&&", " ", 
          RowBox[{"f", " ", "=!=", " ", 
           RowBox[{"Hold", "[", 
            RowBox[{"{", "}"}], "]"}]}]}], ",", " ", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"ReleaseHold", "[", 
           RowBox[{
            RowBox[{"f", "\[LeftDoubleBracket]", 
             RowBox[{"All", ",", " ", "All", ",", " ", 
              RowBox[{"{", 
               RowBox[{"1", ",", " ", "3"}], "}"}]}], 
             "\[RightDoubleBracket]"}], " ", "/.", " ", "v"}], "]"}], ";"}]}],
         "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"compile", " ", "functions"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", 
        RowBox[{
         RowBox[{"Hold", "[", "\"\<I\>\"", "]"}], " ", "/.", " ", "F"}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"f", " ", "=!=", " ", 
           RowBox[{"Hold", "[", "\"\<I\>\"", "]"}]}], " ", "&&", " ", 
          RowBox[{"f", " ", "=!=", " ", 
           RowBox[{"Hold", "@", 
            RowBox[{"{", "}"}]}]}]}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"f", " ", "=", 
           RowBox[{"Thread", "[", "f", "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"c", " ", "=", " ", "RBDCompileExpression"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"v", " ", "=", " ", 
           RowBox[{
            RowBox[{"Hold", "[", 
             RowBox[{"{", 
              RowBox[{"x_", ",", " ", "y_"}], "}"}], "]"}], " ", 
            "\[RuleDelayed]", " ", 
            RowBox[{"c", "[", 
             RowBox[{
              RowBox[{"ToString", "@", 
               RowBox[{"Unevaluated", "@", "x"}]}], ",", " ", "x", ",", " ", 
              "y", ",", " ", "n", ",", " ", "o"}], "]"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Association", "[", 
           RowBox[{"f", " ", "/.", " ", "v"}], "]"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"<|", "|>"}]}], "\[IndentingNewLine]", "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"timer", ",", " ", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"timlst", " ", "=", " ", 
   RowBox[{"{", "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"timer", "[", 
     RowBox[{"x_", ",", " ", "f_", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"s", ",", " ", "t", ",", "r"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"PrependTo", "[", 
         RowBox[{"timlst", ",", " ", 
          RowBox[{
           RowBox[{"StringTemplate", "[", "\"\<`` in `` \>\"", "]"}], "[", 
           RowBox[{"n", ",", " ", "f"}], "]"}]}], "]"}], ";"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"PrependTo", "[", 
        RowBox[{"timlst", ",", " ", 
         RowBox[{
          RowBox[{"ToString", "@", 
           RowBox[{"Unevaluated", "@", "n"}]}], " ", "<>", " ", 
          "\"\< in \>\"", " ", "<>", " ", 
          RowBox[{"ToString", "@", 
           RowBox[{"Unevaluated", "@", "f"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Print", "[", 
          RowBox[{"Row", "@", "timlst"}], "]"}], ";"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"t", ",", " ", "r"}], "}"}], " ", "=", " ", 
        RowBox[{"AbsoluteTiming", "[", "x", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"s", " ", "=", " ", 
        RowBox[{"First", "@", "timlst"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"timlst", " ", "=", " ", 
        RowBox[{"Rest", "@", "timlst"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Print", "[", 
        RowBox[{"\"\<\\t\>\"", ",", " ", "s", ",", " ", 
         RowBox[{"\"\<took \>\"", " ", "<>", " ", 
          RowBox[{"ToString", "@", "t"}], " ", "<>", " ", 
          "\"\< seconds.\>\""}]}], "]"}], ";", "\[IndentingNewLine]", "r"}]}],
      "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDCompileExpression", "[", 
    RowBox[{"name_String", ",", " ", "expr_", ",", " ", "a_", ",", " ", 
     RowBox[{"n_:", "0"}], ",", " ", 
     RowBox[{"o", ":", 
      RowBox[{"OptionsPattern", "[", "Compile", "]"}]}]}], "]"}], " ", ":=", 
   " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"s", ",", " ", "v", ",", " ", "f"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"diff", " ", "name"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"s", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"CreateSymbolString", "[", 
          RowBox[{"name", ",", " ", "#"}], "]"}], "&"}], " ", "/@", " ", 
        RowBox[{"Range", "[", 
         RowBox[{"0", ",", " ", "n"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"get", " ", "Compile", " ", "arguments"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"CompileArgs", "[", 
        RowBox[{"a", ",", " ", "n"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "replace", " ", "\"\<b\>\"", " ", "with", " ", "args", " ", "in", " ", 
        "a"}], " ", "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"ReleaseHold", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"Hold", "@", 
          RowBox[{"Block", "[", 
           RowBox[{"\"\<b\>\"", ",", " ", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"SetAttributes", "[", 
              RowBox[{"\"\<b\>\"", ",", " ", "NHoldAll"}], "]"}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"(*", " ", 
              RowBox[{"differentiate", " ", "pure", " ", "function"}], " ", 
              "*)"}], "\[IndentingNewLine]", 
             RowBox[{"v", " ", "=", " ", 
              RowBox[{"Select", "[", 
               RowBox[{
                RowBox[{"a", "\[LeftDoubleBracket]", 
                 RowBox[{"All", ",", " ", 
                  RowBox[{"{", 
                   RowBox[{"1", ",", "3"}], "}"}]}], 
                 "\[RightDoubleBracket]"}], ",", " ", 
                RowBox[{
                 RowBox[{
                  RowBox[{"Times", "@@", 
                   RowBox[{
                   "#", "\[LeftDoubleBracket]", "2", 
                    "\[RightDoubleBracket]"}]}], " ", ">", " ", "0"}], 
                 "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"f", " ", "=", " ", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"TensorQ", "[", "expr", "]"}], " ", "||", " ", 
                 RowBox[{"NumericQ", "[", "expr", "]"}]}], ",", " ", 
                RowBox[{"(", 
                 RowBox[{"expr", "&"}], ")"}], ",", " ", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"expr", "[", "##", "]"}], "&"}], ")"}]}], "]"}]}], 
             ";", "\[IndentingNewLine]", 
             RowBox[{"f", " ", "=", " ", 
              RowBox[{"N", "@", 
               RowBox[{"First", "@", 
                RowBox[{"Df", "[", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"{", "f", "}"}], ",", " ", "v"}], "}"}], ",", 
                  " ", "\"\<ch\>\"", ",", " ", 
                  RowBox[{"D", " ", "\[Rule]", " ", "n"}]}], "]"}]}]}]}], ";",
              "\[IndentingNewLine]", 
             RowBox[{"f", "=", " ", 
              RowBox[{"DfToCompiledFunction", "[", 
               RowBox[{"f", ",", " ", 
                RowBox[{"a", "\[LeftDoubleBracket]", 
                 RowBox[{"All", ",", " ", 
                  RowBox[{"{", 
                   RowBox[{"1", ",", "3"}], "}"}]}], 
                 "\[RightDoubleBracket]"}], ",", " ", 
                RowBox[{"a", "\[LeftDoubleBracket]", 
                 RowBox[{"All", ",", " ", "2"}], "\[RightDoubleBracket]"}], 
                ",", " ", "o"}], "]"}]}], ";"}]}], "\[IndentingNewLine]", 
           "]"}]}], " ", "/.", " ", 
         RowBox[{"\"\<b\>\"", " ", "\[Rule]", " ", 
          RowBox[{"Flatten", "[", 
           RowBox[{"v", "\[LeftDoubleBracket]", 
            RowBox[{"All", ",", " ", "All", ",", " ", "1"}], 
            "\[RightDoubleBracket]"}], "]"}]}]}], " ", "/.", " ", 
        RowBox[{
         RowBox[{"Hold", "[", "x_Symbol", "]"}], " ", "\[RuleDelayed]", " ", 
         "x"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"AssociationThread", "[", 
       RowBox[{"s", " ", "\[Rule]", " ", "f"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.7177296735436068`*^9, 3.7177296912937737`*^9}, {
   3.7177298616391597`*^9, 3.7177298629516706`*^9}, {3.7177301058914866`*^9, 
   3.7177301158603096`*^9}, 3.7177302024236317`*^9, {3.71773033565929*^9, 
   3.717730432050831*^9}, {3.7177304852075853`*^9, 3.717730565739585*^9}, {
   3.7177306449903536`*^9, 3.717730645552842*^9}, {3.7177307205848174`*^9, 
   3.717730724147369*^9}, {3.717730767897772*^9, 3.7177307858666925`*^9}, {
   3.7177312271365066`*^9, 3.7177313247311883`*^9}, {3.7177313735441537`*^9, 
   3.7177313863724*^9}, {3.717731426513401*^9, 3.7177314525605288`*^9}, {
   3.717731508264168*^9, 3.7177315104204364`*^9}, {3.717731577030445*^9, 
   3.7177316718126097`*^9}, 3.717731744078925*^9, {3.71773232927197*^9, 
   3.7177323388033085`*^9}, {3.717732382850604*^9, 3.717732386303777*^9}, {
   3.717732421147854*^9, 3.717732450679385*^9}, {3.717732621602872*^9, 
   3.71773262932171*^9}, {3.7177326651189113`*^9, 3.7177326694470935`*^9}, 
   3.717732703900545*^9, 3.717732735994599*^9, 3.7177328174797506`*^9, {
   3.717759039271948*^9, 3.7177590423500967`*^9}, {3.717772283055875*^9, 
   3.7177723198218613`*^9}, {3.717772660184458*^9, 3.7177726836690683`*^9}, {
   3.717773127735793*^9, 3.7177732248460855`*^9}, {3.7177732698933897`*^9, 
   3.7177733324564877`*^9}, {3.717773545599121*^9, 3.7177736019590344`*^9}, {
   3.717773674022219*^9, 3.7177736825222993`*^9}, {3.717773832258112*^9, 
   3.717773832773727*^9}, {3.7177738785398026`*^9, 3.7177739237902336`*^9}, {
   3.7177739688687816`*^9, 3.717774129839051*^9}, {3.7177742379182005`*^9, 
   3.717774239355732*^9}, {3.7177743397160597`*^9, 3.717774523624055*^9}, {
   3.7177745711401353`*^9, 3.7177745877965393`*^9}, {3.7177746277031674`*^9, 
   3.7177746424220624`*^9}, {3.7177746925162725`*^9, 3.71777470625079*^9}, {
   3.7177747874703107`*^9, 3.717774848252143*^9}, {3.7177749175809226`*^9, 
   3.7177749847690616`*^9}, {3.7177750478477755`*^9, 3.717775085457507*^9}, {
   3.7177751224266186`*^9, 3.7177751528018966`*^9}, {3.7177751861459637`*^9, 
   3.7177751972554445`*^9}, {3.71777527530306*^9, 3.7177753038814683`*^9}, {
   3.7177753344598846`*^9, 3.717775404601165*^9}, {3.717775557352615*^9, 
   3.717775559758906*^9}, {3.7177756007749147`*^9, 3.7177757848235393`*^9}, {
   3.717776942084527*^9, 3.717776946209567*^9}, 3.7177770236165533`*^9, {
   3.717777079601459*^9, 3.717777142055177*^9}, {3.717777973266201*^9, 
   3.717777977797495*^9}, {3.717778074845301*^9, 3.717778092907961*^9}, {
   3.7177781404084153`*^9, 3.717778142095929*^9}, {3.717778629475562*^9, 
   3.7177787343203077`*^9}, {3.717778768883147*^9, 3.7177787757894526`*^9}, {
   3.7177788219461517`*^9, 3.7177789258846292`*^9}, {3.7177789575255656`*^9, 
   3.7177789901977525`*^9}, {3.7177790283699927`*^9, 3.71777903065125*^9}, {
   3.717779616011091*^9, 3.717779621792405*^9}, {3.717870168736678*^9, 
   3.7178702216903005`*^9}, 3.7178707561172543`*^9, {3.717870881571576*^9, 
   3.717870896884217*^9}, {3.7178725301341033`*^9, 3.7178726619791203`*^9}, {
   3.7178818690607867`*^9, 3.717881902795477*^9}, {3.7178819350457726`*^9, 
   3.7178819374364195`*^9}, {3.7178819693898478`*^9, 3.717882001921407*^9}, {
   3.717882068687682*^9, 3.717882075468989*^9}, 3.717892185444929*^9, {
   3.7178922543205957`*^9, 3.7178923209618545`*^9}, {3.717892428103485*^9, 
   3.717892438634848*^9}, {3.7178924728539095`*^9, 3.7178924927447243`*^9}, {
   3.7178926159802713`*^9, 3.7178926238553476`*^9}, {3.717893062715247*^9, 
   3.7178930666996613`*^9}, {3.7178934343437786`*^9, 
   3.7178934408907166`*^9}, {3.7178939517861977`*^9, 3.717893952239326*^9}, {
   3.717894875098097*^9, 3.7178948893638735`*^9}, {3.7180532906146126`*^9, 
   3.718053315021077*^9}, {3.7180535093352747`*^9, 3.718053527147914*^9}, {
   3.7180552235938034`*^9, 3.718055291845079*^9}, {3.718055467398261*^9, 
   3.7180554912847404`*^9}, 3.718055546830855*^9, {3.718055606563671*^9, 
   3.7180556328224173`*^9}, {3.718067961633009*^9, 3.7180679624611473`*^9}, {
   3.7180683735550756`*^9, 3.7180683737894535`*^9}, {3.718223777098852*^9, 
   3.718223814786725*^9}, {3.718224691037537*^9, 3.7182246939438267`*^9}, {
   3.7182247302097974`*^9, 3.7182247308973045`*^9}, {3.7182268506918755`*^9, 
   3.7182268550825596`*^9}, {3.7182473422075806`*^9, 3.718247398520626*^9}, {
   3.718247490346185*^9, 3.7182474937524815`*^9}, {3.7182475801439505`*^9, 
   3.718247605019209*^9}, {3.7182477470987234`*^9, 3.7182477490206165`*^9}, {
   3.7182478392246337`*^9, 3.718247839490261*^9}, {3.71824789731897*^9, 
   3.7182479381318645`*^9}, {3.7182479993199687`*^9, 
   3.7182480008356233`*^9}, {3.718278501282132*^9, 3.7182785030321503`*^9}, 
   3.718278541407544*^9, {3.718278593189291*^9, 3.718278596204948*^9}, {
   3.718278784534933*^9, 3.718278829441625*^9}, 3.7182788649732275`*^9, {
   3.718279126598038*^9, 3.7182791291449375`*^9}, {3.718279447148082*^9, 
   3.718279519992566*^9}, {3.7182795833994284`*^9, 3.718279591774511*^9}, {
   3.718279654775133*^9, 3.7182796576189117`*^9}, 3.718279695197409*^9, 
   3.7183166857249823`*^9, {3.718381862271079*^9, 3.718381863739845*^9}, 
   3.71838189577141*^9, {3.7183821128673058`*^9, 3.718382135367541*^9}, {
   3.718385901872284*^9, 3.7183859026066513`*^9}, {3.718386151046607*^9, 
   3.71838616535926*^9}, {3.7183862227973146`*^9, 3.7183862521413546`*^9}, 
   3.7183863017043447`*^9, 3.7183869968790784`*^9, {3.718403777431118*^9, 
   3.7184037848843145`*^9}, {3.71840386719763*^9, 3.7184038711351843`*^9}, {
   3.718708613816662*^9, 3.7187086226761255`*^9}, {3.71870869041117*^9, 
   3.718708695723721*^9}, {3.7187088810933*^9, 3.718708922703085*^9}, {
   3.7187090392218494`*^9, 3.7187090405812397`*^9}, {3.7187093035057125`*^9, 
   3.7187093541780896`*^9}, {3.718709425366291*^9, 3.7187094308819714`*^9}, {
   3.7187094648979483`*^9, 3.718709470226109*^9}, {3.7187096890095215`*^9, 
   3.718709690431411*^9}, {3.718710437970061*^9, 3.7187104724703894`*^9}, {
   3.719525445137063*^9, 3.7195254477929354`*^9}, {3.71952552961858*^9, 
   3.7195255658188505`*^9}, {3.7195257368166094`*^9, 
   3.7195257384728737`*^9}, {3.7195259312557535`*^9, 3.719525931474506*^9}, {
   3.7195266623471794`*^9, 3.7195266672065954`*^9}, {3.7263465843503156`*^9, 
   3.7263466390226684`*^9}, {3.7263500679685574`*^9, 
   3.7263500699685736`*^9}, {3.769739180880723*^9, 3.769739217902134*^9}},
 CellLabel->"In[24]:=",ExpressionUUID->"31edee34-209f-48d8-8c6f-7d5a7f090bfa"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Compile Function Modules", "Section",
 CellChangeTimes->{{3.5914870039053636`*^9, 3.591487004222381*^9}, {
  3.7188357364669695`*^9, 
  3.718835785170576*^9}},ExpressionUUID->"0c24cb1d-bb29-454f-9ea3-\
074267fe3a8f"],

Cell["\<\
for no constraints create C as follows:
\t\[OpenCurlyDoubleQuote]C\[CloseCurlyDoubleQuote] -> \
{\[OpenCurlyDoubleQuote]left\[CloseCurlyDoubleQuote] -> None, \
\[OpenCurlyDoubleQuote]right\[CloseCurlyDoubleQuote] -> None}\
\>", "Text",
 CellChangeTimes->{{3.739880957183217*^9, 3.739881007647687*^9}, {
  3.739895504859826*^9, 
  3.7398955049476624`*^9}},ExpressionUUID->"fd4f07c2-f162-4758-a4b3-\
c51afea31a80"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "RBDCompileFunction", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<S\>\"", " ", "\[Rule]", " ", "spatfun"}], ",", " ", 
      RowBox[{"\"\<C\>\"", " ", "\[Rule]", " ", "confun"}], ",", " ", 
      RowBox[{"\"\<D\>\"", " ", "\[Rule]", " ", "datrules"}], ",", " ", 
      RowBox[{"\"\<a\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", 
        RowBox[{"1", ",", "2"}], "}"}]}], ",", " ", 
      RowBox[{"\"\<e\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<f\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"CompilationOptions", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"\"\<InlineCompiledFunctions\>\"", "\[Rule]", "True"}], 
            ",", " ", 
            RowBox[{"\"\<ExpressionOptimization\>\"", "\[Rule]", "True"}]}], 
           "}"}]}], ",", " ", 
         RowBox[{"CompilationTarget", " ", "\[Rule]", " ", "\"\<C\>\""}]}], 
        "}"}]}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDCompileFunction", "[", 
    RowBox[{"F_List", ",", " ", "n_", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "f", ",", " ", "a", ",", " ", "d", ",", " ", "A", ",", " ", "S", ",", 
       " ", "C", ",", " ", "D", ",", " ", "slot", ",", " ", "part"}], "}"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
        RowBox[{"don", "'"}], "t", " ", "use", " ", "variable", " ", "slot"}],
        ",", " ", 
       RowBox[{"must", " ", "be", " ", "kept", " ", "a", " ", "symbol"}]}], 
      " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"S", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<S\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"C", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<C\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"D", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<D\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"extract", " ", "fcns", " ", "in", " ", "S"}], " ", "&"}], 
         " ", "C", " ", "and", " ", "create", " ", "replacement", " ", 
         RowBox[{"rule", ":", " ", "f"}]}], " ", "\[RuleDelayed]", " ", 
        RowBox[{"f", "[", "x", "]"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"A", " ", "=", " ", 
       RowBox[{"Join", "@@", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{"CreateInlinedFunctionHeaders", "[", 
            RowBox[{"#", ",", " ", "n"}], "]"}], "&"}], " ", "/@", " ", 
          RowBox[{"{", 
           RowBox[{"S", ",", " ", "C"}], "}"}]}], ")"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "compile", " ", "functions", " ", "in", " ", "S", " ", "once", " ", 
        "and", " ", "create", " ", "rep", " ", 
        RowBox[{"rules", ":"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"S", " ", "=", " ", 
       RowBox[{"RulesForInlinedFunctions", "[", 
        RowBox[{"S", ",", " ", "n", ",", " ", 
         RowBox[{"OptionValue", "[", "\"\<e\>\"", "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"A", ",", " ", "S"}], "}"}], " ", "=", " ", 
       RowBox[{"Dispatch", " ", "/@", " ", 
        RowBox[{"{", 
         RowBox[{"A", ",", " ", "S"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Association", "@", 
       RowBox[{"Table", "[", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"compile", " ", "constraints"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"f", "=", " ", 
           RowBox[{"Table", "[", "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
             "tie", " ", "arguments", " ", "of", " ", "f", " ", "to", " ", 
              "variables", " ", "in", " ", "\"\<v\>\"", " ", "and", " ", 
              "\"\<d\>\""}], " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"d", " ", "=", " ", 
               RowBox[{
                RowBox[{"JoinInputArguments", "[", 
                 RowBox[{"Fi", ",", " ", "n"}], "]"}], "\[LeftDoubleBracket]", 
                RowBox[{"All", ",", " ", "1"}], "\[RightDoubleBracket]"}]}], 
              ";", "\[IndentingNewLine]", 
              RowBox[{"f", " ", "=", " ", 
               RowBox[{
                RowBox[{
                 RowBox[{"Hold", "[", "\"\<f\>\"", "]"}], "@@", "d"}], "  ", "/.",
                 " ", "A"}]}], " ", ";", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"(*", " ", 
               RowBox[{
                RowBox[{"replace", " ", "independent", " ", "args", " ", 
                 RowBox[{"w", "/", " ", 
                  RowBox[{"Slot", "[", "...", "]"}]}]}], ";", " ", 
                RowBox[{
                "slot", " ", "should", " ", "be", " ", "a", " ", "symbol", 
                 " ", "here"}]}], " ", "*)"}], "\[IndentingNewLine]", 
              RowBox[{"a", " ", "=", " ", 
               RowBox[{
                RowBox[{"Partition", "[", 
                 RowBox[{"d", ",", " ", 
                  RowBox[{"n", "+", "1"}]}], "]"}], "\[LeftDoubleBracket]", 
                RowBox[{"OptionValue", "[", "\"\<a\>\"", "]"}], 
                "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"f", " ", "=", " ", 
               RowBox[{"InsertDevecedArguments", "[", 
                RowBox[{"f", ",", " ", "a"}], "]"}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"(*", " ", 
               RowBox[{
               "add", " ", "family", " ", "of", " ", "S", " ", "fcns"}], " ", 
               "*)"}], "\[IndentingNewLine]", 
              RowBox[{"f", " ", "=", " ", 
               RowBox[{"f", " ", "/.", " ", "S"}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"(*", " ", 
               RowBox[{
               "add", " ", "in", " ", "family", " ", "of", " ", "C", " ", 
                "fcns"}], " ", "*)"}], "\[IndentingNewLine]", 
              RowBox[{"RBDConstraintFunctions", "[", 
               RowBox[{"Fi", "[", 
                RowBox[{"\"\<C\>\"", ",", " ", "c"}], "]"}], "]"}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"d", " ", "=", " ", 
               RowBox[{"RulesForInlinedFunctions", "[", 
                RowBox[{"C", ",", " ", "n", ",", " ", 
                 RowBox[{"OptionValue", "[", "\"\<e\>\"", "]"}]}], "]"}]}], 
              ";", "\[IndentingNewLine]", 
              RowBox[{"f", " ", "=", " ", 
               RowBox[{
                RowBox[{"f", " ", "/.", " ", "d"}], " ", "/.", " ", 
                RowBox[{"Block", "[", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"RuleDelayed", " ", "=", " ", "Rule"}], "}"}], ",",
                   " ", "D"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"c", " ", "\[Rule]", " ", "f"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"{", 
              RowBox[{"c", ",", " ", 
               RowBox[{"Keys", "@", 
                RowBox[{"Fi", "[", "\"\<C\>\"", "]"}]}]}], "}"}]}], 
            "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"compile", " ", "function", " ", "in", " ", "F"}], " ", 
           "*)"}], "\[IndentingNewLine]", 
          RowBox[{"f", " ", "=", " ", 
           RowBox[{"f", " ", "/.", " ", 
            RowBox[{"\"\<f\>\"", " ", "\[Rule]", " ", 
             RowBox[{"CompileFunction", "[", 
              RowBox[{"Fi", ",", " ", "n", ",", " ", 
               RowBox[{"OptionValue", "[", "\"\<f\>\"", "]"}]}], "]"}]}]}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{"f", " ", "=", " ", 
           RowBox[{"f", " ", "/.", " ", 
            RowBox[{
             RowBox[{"Hold", "[", "x_", "]"}], " ", "\[RuleDelayed]", " ", 
             "x"}]}]}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Fi", "[", "\"\<name\>\"", "]"}], " ", "\[Rule]", " ", 
           RowBox[{"Association", "[", "f", "]"}]}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"Fi", ",", " ", "F"}], "}"}]}], "\[IndentingNewLine]", 
        "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.718067440971603*^9, 3.71806752115991*^9}, {
   3.7180675635821896`*^9, 3.7180675673791184`*^9}, {3.718067613223304*^9, 
   3.718067641739213*^9}, {3.7180679243982697`*^9, 3.7180679517266507`*^9}, {
   3.718067999195881*^9, 3.7180680517276382`*^9}, 3.718068188146993*^9, 
   3.718068254772642*^9, {3.718068291429264*^9, 3.7180682921323977`*^9}, {
   3.7180683532111135`*^9, 3.718068359398676*^9}, {3.718068422852426*^9, 
   3.718068438368205*^9}, {3.7180684837436695`*^9, 3.7180685270409684`*^9}, {
   3.7180686205575056`*^9, 3.7180686317607536`*^9}, {3.718068789621688*^9, 
   3.718068791106067*^9}, {3.718068822153247*^9, 3.718068930482456*^9}, {
   3.718068965935918*^9, 3.718068968248454*^9}, {3.71806904787423*^9, 
   3.7180690489836273`*^9}, {3.71806920604768*^9, 3.7180692068758183`*^9}, {
   3.718069243673051*^9, 3.718069265673256*^9}, {3.7180693230488243`*^9, 
   3.7180693417052755`*^9}, {3.718069436878086*^9, 3.718069511863202*^9}, {
   3.7180695585980277`*^9, 3.7180697299903564`*^9}, {3.718069894226346*^9, 
   3.718069916679706*^9}, {3.7180700026805553`*^9, 3.718070081743821*^9}, {
   3.718070238604763*^9, 3.718070396668822*^9}, {3.7180704280284953`*^9, 
   3.7180704810758953`*^9}, {3.718070530154521*^9, 3.7180706830466385`*^9}, {
   3.718070715703212*^9, 3.718070802204069*^9}, {3.7180709251844406`*^9, 
   3.7180709895600724`*^9}, {3.7180710340605*^9, 3.7180711392959175`*^9}, {
   3.7180711790619454`*^9, 3.7180711862963963`*^9}, {3.7180712242937346`*^9, 
   3.7180712490299997`*^9}, {3.718071315780644*^9, 3.718071345577814*^9}, {
   3.71807138025003*^9, 3.718071535798445*^9}, {3.718071567564925*^9, 
   3.7180717338009434`*^9}, {3.7180717757544937`*^9, 
   3.7180718380988617`*^9}, {3.7180718756617374`*^9, 3.718071912162092*^9}, {
   3.7180719485530653`*^9, 3.71807197256894*^9}, {3.718072027772598*^9, 
   3.718072027960103*^9}, {3.718072090945099*^9, 3.718072108085909*^9}, {
   3.718072143586246*^9, 3.7180723486351576`*^9}, 3.7180723829479856`*^9, {
   3.7180724178858423`*^9, 3.7180724756520376`*^9}, {3.718072522590002*^9, 
   3.7180726103877316`*^9}, {3.718072671732105*^9, 3.7180729236564655`*^9}, {
   3.7180729655631313`*^9, 3.718073025876214*^9}, {3.7180730600953026`*^9, 
   3.7180730672203875`*^9}, {3.718073100908207*^9, 3.7180731424242516`*^9}, 
   3.718073359410775*^9, {3.71807351119351*^9, 3.7180735311624727`*^9}, {
   3.7180742366069307`*^9, 3.7180742416694794`*^9}, {3.7183170430312424`*^9, 
   3.718317045124997*^9}, {3.718375573390378*^9, 3.718375576890401*^9}, {
   3.7183756658600464`*^9, 3.7183756895165143`*^9}, {3.7183757589859505`*^9, 
   3.718375767142293*^9}, {3.7183758077208233`*^9, 3.718375874221472*^9}, 
   3.7183759140343738`*^9, 3.7184029708124604`*^9, {3.718403095923066*^9, 
   3.7184030997824774`*^9}, {3.7184031331109343`*^9, 
   3.7184031578299284`*^9}, {3.7184031919865155`*^9, 3.718403200205345*^9}, {
   3.718403918260649*^9, 3.718403920448154*^9}, {3.718403967417368*^9, 
   3.718403987558195*^9}, {3.718404100574937*^9, 3.7184041284658375`*^9}, 
   3.718404171810015*^9, {3.7184042631859193`*^9, 3.718404277076703*^9}, {
   3.7184043385460367`*^9, 3.7184043403429313`*^9}, {3.7184054572914705`*^9, 
   3.718405543464212*^9}, {3.718405582214591*^9, 3.7184056712623353`*^9}, {
   3.7184058069921646`*^9, 3.718405849773821*^9}, {3.7184059136025767`*^9, 
   3.718406018151436*^9}, {3.718406187278105*^9, 3.718406222653472*^9}, {
   3.718406283138429*^9, 3.718406384811307*^9}, {3.7184064173272552`*^9, 
   3.7184064200147963`*^9}, {3.718406656220256*^9, 3.7184067174083457`*^9}, {
   3.7184068650816813`*^9, 3.718406983239113*^9}, {3.718407024677023*^9, 
   3.7184070482866273`*^9}, {3.718407107693452*^9, 3.7184071215842314`*^9}, {
   3.718407152459521*^9, 3.7184072087413273`*^9}, 3.718407243522919*^9, {
   3.7184072889296303`*^9, 3.718407289398389*^9}, {3.718407572119917*^9, 
   3.7184075906982417`*^9}, {3.718407824700556*^9, 3.7184078288880963`*^9}, {
   3.718407897841914*^9, 3.718407905857592*^9}, {3.718407991233436*^9, 
   3.718408088515647*^9}, {3.718408259032958*^9, 3.7184083297367797`*^9}, {
   3.7184083691903114`*^9, 3.718408400768734*^9}, 3.7184084709100533`*^9, {
   3.7184085476764536`*^9, 3.7184087389439507`*^9}, {3.7184087785849824`*^9, 
   3.7184088616951747`*^9}, {3.718408950024162*^9, 3.718409136260378*^9}, {
   3.718409171698227*^9, 3.71840917801079*^9}, {3.7184092140580215`*^9, 
   3.7184093003713813`*^9}, {3.7184093401998916`*^9, 3.718409340621787*^9}, {
   3.718409374606493*^9, 3.7184093812784348`*^9}, {3.718670863953269*^9, 
   3.7186708849534616`*^9}, {3.718671263931692*^9, 3.71867126786923*^9}, {
   3.718723674552767*^9, 3.718723675037135*^9}, {3.718724225451468*^9, 
   3.718724226263977*^9}, {3.718725344603154*^9, 3.7187253480875807`*^9}, {
   3.718725462291818*^9, 3.718725467901248*^9}, {3.7187255289174767`*^9, 
   3.7187255377925634`*^9}, {3.7187255958556376`*^9, 3.718725712778669*^9}, {
   3.71872581063901*^9, 3.7187258436237106`*^9}, {3.7187259133744*^9, 
   3.7187260761728845`*^9}, {3.7187262460027046`*^9, 
   3.7187262820655622`*^9}, {3.7187264030476413`*^9, 
   3.7187264517043724`*^9}, {3.7187265181894045`*^9, 
   3.7187265285488815`*^9}, {3.7187268029734707`*^9, 3.718726812489205*^9}, {
   3.718729539094273*^9, 3.7187295510475225`*^9}, 3.718729714330385*^9, 
   3.7187297505963516`*^9, {3.7187303456334953`*^9, 3.7187304223530035`*^9}, {
   3.718730479603556*^9, 3.718730481384837*^9}, {3.7187306159486713`*^9, 
   3.7187306281004305`*^9}, {3.7187307205701075`*^9, 3.71873074183593*^9}, {
   3.7187309619474964`*^9, 3.718730993432167*^9}, {3.718731049245234*^9, 
   3.718731049635848*^9}, {3.718731110777076*^9, 3.7187311502462335`*^9}, {
   3.718731247528428*^9, 3.7187312487784405`*^9}, {3.718731544156376*^9, 
   3.7187315669847097`*^9}, {3.718731718454959*^9, 3.7187317343613663`*^9}, 
   3.7187319551291714`*^9, {3.71873210416191*^9, 3.71873210984945*^9}, {
   3.7187321888502474`*^9, 3.7187321926315184`*^9}, {3.7187322946481686`*^9, 
   3.71873232832036*^9}, {3.718732381258396*^9, 3.71873239349288*^9}, {
   3.718732575854073*^9, 3.7187325834322577`*^9}, {3.7187326158388276`*^9, 
   3.7187326584329987`*^9}, {3.7187328253096647`*^9, 3.718732885044612*^9}, {
   3.718732973467377*^9, 3.7187330355148497`*^9}, {3.718733102062382*^9, 
   3.718733137500249*^9}, 3.718733273048447*^9, {3.71873332143955*^9, 
   3.718733375330708*^9}, 3.7187334710347786`*^9, 3.7187335045351095`*^9, {
   3.718733550910584*^9, 3.7187335875828056`*^9}, {3.718733694615115*^9, 
   3.7187337137403154`*^9}, {3.7187337800690985`*^9, 3.7187337834129*^9}, {
   3.718733872663765*^9, 3.7187339126172676`*^9}, {3.718734082103319*^9, 
   3.718734122603719*^9}, {3.718734172994841*^9, 3.7187341755573792`*^9}, {
   3.7187342668826094`*^9, 3.7187343571335*^9}, {3.7187344104309015`*^9, 
   3.7187344502594194`*^9}, {3.718734587120165*^9, 3.718734604370319*^9}, {
   3.718734634854994*^9, 3.7187346381206646`*^9}, {3.7187347654969225`*^9, 
   3.718734766028178*^9}, {3.7187348291537914`*^9, 3.718734876044897*^9}, {
   3.718734940592391*^9, 3.718734942076793*^9}, {3.7187349853272085`*^9, 
   3.7187349897803946`*^9}, {3.7187354472658195`*^9, 
   3.7187354474845715`*^9}, {3.71952485127815*^9, 3.719524869575161*^9}, {
   3.719524961888434*^9, 3.7195249772010612`*^9}, {3.719525069733571*^9, 
   3.719525073764841*^9}, {3.7195251296403103`*^9, 3.7195251326872215`*^9}, {
   3.71952525952356*^9, 3.7195252621949453`*^9}, {3.719525307546508*^9, 
   3.719525310985424*^9}, {3.7195253753907065`*^9, 3.7195253787215605`*^9}, {
   3.7195266533627267`*^9, 3.719526656690881*^9}, {3.7202095760930133`*^9, 
   3.720209608905835*^9}, {3.720209674000184*^9, 3.720209688922211*^9}, {
   3.72020973326637*^9, 3.720209735313277*^9}, {3.720209771985488*^9, 
   3.72020978167308*^9}, {3.720209852095625*^9, 3.7202098787208796`*^9}, {
   3.720209914299341*^9, 3.7202099660342083`*^9}, 3.7202100253629084`*^9, {
   3.7202100714883347`*^9, 3.720210080347808*^9}, {3.720210203817729*^9, 
   3.7202102189741125`*^9}, {3.7202102580847807`*^9, 3.720210268444254*^9}, {
   3.7202103583826246`*^9, 3.7202104227426043`*^9}, 3.720210453055383*^9, {
   3.720210490961993*^9, 3.7202105102121744`*^9}, {3.7202110077325296`*^9, 
   3.7202110179513907`*^9}, {3.7202110520298405`*^9, 3.720211064358082*^9}},
 CellLabel->"In[30]:=",ExpressionUUID->"447fbcf5-bc18-4fb4-8d21-cc65c7f71170"],

Cell[CellGroupData[{

Cell["Helper functions", "Subsection",
 CellChangeTimes->{{3.5914870039053636`*^9, 3.591487004222381*^9}, {
  3.7188357364669695`*^9, 3.718835743545165*^9}, {3.7188358027332516`*^9, 
  3.7188358045926437`*^9}},ExpressionUUID->"faec4d56-5fb4-4ac1-81fa-\
57c2dce0ca06"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"JoinInputArguments", "[", 
    RowBox[{"F_Association", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "d", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "merge", " ", "\"\<v\>\"", " ", "and", " ", "\"\<d\>\"", " ", "without",
        " ", "evaluating", " ", "values", " ", "into", " ", "one", " ", 
       "argument", " ", "list"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"d", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"Hold", "[", 
          RowBox[{"CompileArgs", "[", 
           RowBox[{"\"\<v\>\"", ",", " ", "n", ",", " ", "False"}], "]"}], 
          "]"}], ",", " ", 
         RowBox[{"Hold", "[", 
          RowBox[{"CompileArgs", "[", 
           RowBox[{"\"\<d\>\"", ",", " ", "0", ",", " ", "False"}], "]"}], 
          "]"}]}], "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"d", " ", "=", " ", 
       RowBox[{"d", " ", "/.", " ", "F"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"extract", " ", "symbolic", " ", "arg", " ", "only"}], ",", 
        " ", 
        RowBox[{"drop", " ", "type", " ", "and", " ", "depth"}]}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"Partition", "[", 
       RowBox[{
        RowBox[{"Flatten", "[", 
         RowBox[{"ReleaseHold", "[", "d", "]"}], "]"}], ",", " ", "3"}], 
       "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"InsertDevecedArguments", "[", 
     RowBox[{"f_", ",", " ", "args_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"a", ",", " ", "p", ",", " ", "s"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"replace", " ", "independent", " ", "args", " ", 
         RowBox[{"w", "/", " ", 
          RowBox[{
           RowBox[{"Slot", "[", "i", "]"}], "\[LeftDoubleBracket]", "j", 
           "\[RightDoubleBracket]"}]}]}], ",", " ", 
        RowBox[{"where", " ", "j", " ", "depends", " ", "on", " ", 
         RowBox[{"devec", "[", "..", "]"}]}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"a", " ", "=", " ", 
        RowBox[{"MapIndexed", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"#1", " ", "\[Rule]", " ", 
             RowBox[{"p", "[", 
              RowBox[{
               RowBox[{"s", "[", 
                RowBox[{
                "#2", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
                "]"}], ",", " ", 
               RowBox[{
               "#2", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}],
               "]"}]}], ")"}], "&"}], ",", " ", "args", ",", " ", 
          RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"a", " ", "=", " ", 
        RowBox[{
         RowBox[{"Flatten", "@", "a"}], " ", "/.", " ", 
         RowBox[{"{", 
          RowBox[{"Hold", " ", "\[Rule]", " ", "HoldPattern"}], "}"}]}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"e", " ", "=", " ", "f"}], "}"}], ",", " ", 
            RowBox[{"e", "&"}]}], "]"}], " ", "/.", " ", "a"}], " ", "/.", 
         " ", 
         RowBox[{"s", " ", "\[Rule]", " ", "Slot"}]}], " ", "/.", " ", 
        RowBox[{"p", " ", "\[Rule]", " ", "Part"}]}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RulesForInlinedFunctions", "[", 
     RowBox[{"S_", ",", " ", "n_", ",", " ", 
      RowBox[{"o", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "f", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "create", " ", "replacement", " ", "rules", " ", "for", " ", 
        "arguments", " ", "of", " ", "f"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"f", " ", "=", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"ToExpression", "[", 
           RowBox[{"#1", ",", " ", "InputForm", ",", " ", "HoldPattern"}], 
           "]"}], " ", "\[RuleDelayed]", " ", "#2"}], "&"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
        "compile", " ", "functions", " ", "in", " ", "A", " ", "and", " ", 
         "create", " ", "rep", " ", 
         RowBox[{"rules", ":"}]}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{"HoldPattern", "[", "f", "]"}], " ", "\[RuleDelayed]", " ", 
         "CompiledFunction"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"KeyValueMap", "[", 
        RowBox[{"f", ",", " ", 
         RowBox[{"RBDCompileExpression", "[", 
          RowBox[{"S", ",", " ", "n", ",", " ", "o"}], "]"}]}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateInlinedFunctionHeaders", "[", 
     RowBox[{"S_Association", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"A", ",", " ", "a", ",", " ", "f"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "extract", " ", "fcns", " ", "in", " ", "A", " ", "and", " ", 
         "create", " ", "replacement", " ", 
         RowBox[{"rule", ":", " ", "f"}]}], " ", "\[RuleDelayed]", " ", 
        RowBox[{"f", "[", "x", "]"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"A", " ", "=", " ", 
        RowBox[{
         RowBox[{"Hold", "[", "\"\<I\>\"", "]"}], " ", "/.", " ", "S"}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"With", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"e", " ", "=", " ", "A"}], "}"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"BlockExpression", "[", 
          RowBox[{
           RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{"create", " ", "0"}], "-", 
             RowBox[{"th", " ", "order", " ", "function", " ", "call"}]}], 
            " ", "*)"}], "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"a", " ", "=", " ", 
             RowBox[{
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                 "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
                 ",", " ", 
                 RowBox[{
                  RowBox[{
                  "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}],
                   "@@", 
                  RowBox[{"(", 
                   RowBox[{"#", "\[LeftDoubleBracket]", 
                    RowBox[{"2", ",", " ", "All", ",", " ", "1"}], 
                    "\[RightDoubleBracket]"}], ")"}]}]}], "}"}], "&"}], " ", "/@",
               " ", 
              RowBox[{"Join", "@", 
               RowBox[{"ReleaseHold", "[", "e", "]"}]}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{"expand", " ", "up", " ", "to", " ", "n"}], "-", 
              RowBox[{"th", " ", "order", " ", "function", " ", "call"}]}], 
             " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{"f", " ", "=", " ", 
             RowBox[{
              RowBox[{"Table", "[", 
               RowBox[{
                RowBox[{"CreateSymbol", "[", 
                 RowBox[{
                  RowBox[{"\[FormalP]", "[", "#", "]"}], ",", " ", "i", ",", 
                  " ", "Hold"}], "]"}], ",", " ", 
                RowBox[{"{", 
                 RowBox[{"i", ",", " ", "0", ",", " ", "n"}], "}"}]}], "]"}], 
              "&"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"a", " ", "=", " ", 
             RowBox[{"Map", "[", 
              RowBox[{"f", ",", " ", "a", ",", " ", 
               RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{"create", " ", 
               RowBox[{"HoldPattern", "[", "f", "]"}]}], " ", 
              "\[RuleDelayed]", " ", 
              RowBox[{"f", "[", 
               RowBox[{"x", ",", " ", "..."}], "]"}]}], " ", "*)"}], 
            "\[IndentingNewLine]", 
            RowBox[{"a", " ", "=", " ", 
             RowBox[{"MapThread", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"HoldPattern", "[", "#1", "]"}], " ", 
                 "\[RuleDelayed]", " ", "#2"}], "&"}], ",", " ", 
               RowBox[{"a", "\[Transpose]"}], ",", " ", "2"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Flatten", "@", "a"}], " ", "/.", " ", 
             RowBox[{
              RowBox[{"Hold", "[", "x_", "]"}], " ", "\[RuleDelayed]", " ", 
              "x"}]}]}], ",", " ", "\[IndentingNewLine]", 
           RowBox[{"{", 
            RowBox[{
            "CreateSymbol", ",", " ", "a", ",", " ", "Hold", ",", " ", 
             "Join"}], "}"}]}], "\[IndentingNewLine]", "]"}]}], 
        "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"CompileFunction", "[", 
    RowBox[{"F_Association", ",", " ", "n_", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "Compile", "]"}]}]}], "]"}], " ", ":=", 
   " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "f", ",", " ", "i", ",", " ", "d", ",", " ", "C", ",", " ", "I"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
        RowBox[{"compile", " ", "inline", " ", "expressions"}], ";", " ", 
        RowBox[{"override", " ", "inline", " ", "with", " ", 
         RowBox[{"F", "'"}], "s"}]}], ",", " ", 
       RowBox[{"if", " ", "key", " ", "collision"}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"I", " ", "=", " ", 
       RowBox[{"RBDCompileExpression", "[", 
        RowBox[{
         RowBox[{"F", "\[LeftDoubleBracket]", 
          RowBox[{"{", 
           RowBox[{"\"\<I\>\"", ",", " ", "\"\<O\>\""}], "}"}], 
          "\[RightDoubleBracket]"}], ",", " ", "n"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{
        RowBox[{"ToExpression", "[", 
         RowBox[{
         "\"\<HoldPattern[\>\"", " ", "<>", " ", "#", " ", "<>", " ", 
          "\"\<]\>\""}], "]"}], "&"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"I", " ", "=", " ", 
       RowBox[{"KeyMap", "[", 
        RowBox[{"f", ",", " ", "I"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "add", " ", "\"\<v\>\"", " ", "and", " ", "\"\<d\>\"", " ", "to", " ", 
        RowBox[{"depth", "[", "...", "]"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{
        RowBox[{"Hold", "[", "\"\<v\>\"", "]"}], "/.", " ", "F"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"f", " ", "=!=", " ", 
          RowBox[{"Hold", "[", "\"\<v\>\"", "]"}]}], " ", "&&", " ", 
         RowBox[{"f", " ", "=!=", " ", 
          RowBox[{"Hold", "[", 
           RowBox[{"{", "}"}], "]"}]}]}], ",", " ", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"ReleaseHold", "[", 
          RowBox[{
           RowBox[{"f", "\[LeftDoubleBracket]", 
            RowBox[{"All", ",", " ", "All", ",", " ", 
             RowBox[{"{", 
              RowBox[{"1", ",", " ", "3"}], "}"}]}], 
            "\[RightDoubleBracket]"}], " ", "/.", " ", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"v_Symbol", ",", " ", "i_Integer"}], "}"}], " ", 
            "\[RuleDelayed]", " ", 
            RowBox[{"depth", "[", 
             RowBox[{"v", ",", " ", "i", ",", " ", "n"}], "]"}]}]}], "]"}], 
         ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{
        RowBox[{"Hold", "[", "\"\<d\>\"", "]"}], "/.", " ", "F"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"f", " ", "=!=", " ", 
          RowBox[{"Hold", "[", "\"\<d\>\"", "]"}]}], " ", "&&", " ", 
         RowBox[{"f", " ", "=!=", " ", 
          RowBox[{"Hold", "[", 
           RowBox[{"{", "}"}], "]"}]}]}], ",", " ", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"ReleaseHold", "[", 
          RowBox[{
           RowBox[{"f", "\[LeftDoubleBracket]", 
            RowBox[{"All", ",", " ", "All", ",", " ", 
             RowBox[{"{", 
              RowBox[{"1", ",", " ", "3"}], "}"}]}], 
            "\[RightDoubleBracket]"}], " ", "/.", " ", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"v_Symbol", ",", " ", "i_Integer"}], "}"}], " ", 
            "\[RuleDelayed]", " ", 
            RowBox[{"depth", "[", 
             RowBox[{"v", ",", " ", "i", ",", " ", "0"}], "]"}]}]}], "]"}], 
         ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"create", " ", "function", " ", "to", " ", "compile"}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"ReleaseHold", "[", 
        RowBox[{
         RowBox[{"Hold", "@", 
          RowBox[{"MergeFunctions", "[", 
           RowBox[{"\"\<f\>\"", ",", " ", 
            RowBox[{"C", "[", "]"}], ",", " ", "\"\<lcls\>\"", ",", " ", 
            "n"}], "]"}]}], " ", "/.", " ", "F"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "take", " ", "out", " ", "index", " ", "variables", " ", "that", " ", 
        RowBox[{"aren", "'"}], "t", " ", "directly", " ", "given", " ", "a", 
        " ", "value"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"i", " ", "=", " ", 
       RowBox[{"Cases", "[", 
        RowBox[{"f", ",", " ", 
         RowBox[{
          RowBox[{"HoldPattern", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"Do", "|", "Table"}], ")"}], "[", 
            RowBox[{"_", ",", " ", "x__"}], "]"}], "]"}], " ", 
          "\[RuleDelayed]", " ", 
          RowBox[{"Hold", "[", "x", "]"}]}], ",", " ", "Infinity"}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"d", " ", "=", " ", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"i_", ",", " ", "x_", ",", " ", "___"}], "}"}], " ", 
        "\[RuleDelayed]", " ", 
        RowBox[{"Hold", "@", 
         RowBox[{"SetDelayed", "[", 
          RowBox[{
           RowBox[{"depth", "[", "i", "]"}], ",", " ", 
           RowBox[{
            RowBox[{"depth", "[", "x", "]"}], "-", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Total", "[", 
                RowBox[{"depth", "[", "x", "]"}], "]"}], " ", "\[Equal]", " ",
                "0"}], ",", " ", "0", ",", " ", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"-", "1"}], ",", " ", "0"}], "}"}]}], "]"}]}]}], 
          "]"}]}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"ReleaseHold", "@", 
       RowBox[{"Cases", "[", 
        RowBox[{"i", ",", " ", "d", ",", " ", "Infinity"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"do", " ", "some", " ", "post"}], "-", 
        RowBox[{
        "procesing", " ", "clean", " ", "up", " ", "on", " ", 
         "differentiated", " ", "function"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"FixLinearSolve", "@", 
        RowBox[{"FixDotProducts", "@", 
         RowBox[{"FixFunctions", "[", "f", "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "merge", " ", "\"\<v\>\"", " ", "and", " ", "\"\<d\>\"", " ", 
        "without", " ", "evaluating", " ", "values", " ", "into", " ", "one", 
        " ", "argument", " ", "list"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"d", " ", "=", " ", 
       RowBox[{
        RowBox[{"\"\<v\>\"", " ", "\[RuleDelayed]", " ", 
         RowBox[{"Evaluate", "@", 
          RowBox[{"JoinInputArguments", "[", 
           RowBox[{"F", ",", " ", "n"}], "]"}]}]}], " ", "/.", " ", 
        RowBox[{
         RowBox[{"Hold", "[", "x_", "]"}], " ", "\[RuleDelayed]", " ", 
         "x"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"create", " ", "Compile"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Hold", "[", 
           RowBox[{"Compile", "[", 
            RowBox[{"\"\<v\>\"", ",", " ", 
             RowBox[{"C", "[", "]"}], ",", " ", "opts"}], "]"}], "]"}], " ", "/.",
           " ", "d"}], " ", "/.", " ", 
         RowBox[{"C", " ", "\[Rule]", " ", 
          RowBox[{"CreateSymbol", "[", 
           RowBox[{"C", ",", " ", "n"}], "]"}]}]}], " ", "/.", " ", "f"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"f", " ", "/.", " ", 
        RowBox[{"Normal", "@", "I"}]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"compile", " ", "function"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"ReleaseHold", "[", "f", "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.718730000645711*^9, 3.718730018348998*^9}, {
   3.7187300561462626`*^9, 3.7187301012248173`*^9}, {3.718730136834544*^9, 
   3.7187301902100725`*^9}, {3.718730290086075*^9, 3.7187303074299974`*^9}, {
   3.7187304926349363`*^9, 3.7187306009172564`*^9}, 3.71873063350675*^9, {
   3.7187309403847675`*^9, 3.718730954713036*^9}, {3.7187310235262146`*^9, 
   3.7187310564327908`*^9}, {3.718731134886689*^9, 3.718731140308618*^9}, {
   3.7187312085593095`*^9, 3.7187314072643986`*^9}, {3.7187315069997435`*^9, 
   3.7187315276718216`*^9}, 3.7187319515666523`*^9, {3.7187353632337275`*^9, 
   3.718735364499365*^9}, {3.71883258132066*^9, 3.718832582055043*^9}, {
   3.7193672510262794`*^9, 3.7193672556669393`*^9}, {3.7193681916926627`*^9, 
   3.719368192098915*^9}, {3.719525273084131*^9, 3.7195253016713343`*^9}, {
   3.7202105554782467`*^9, 3.720210561072047*^9}, {3.7202105959629903`*^9, 
   3.7202106414321885`*^9}, {3.7202106769793844`*^9, 3.720210679635677*^9}, {
   3.7202107175110207`*^9, 3.7202108988096266`*^9}, {3.7202109453725595`*^9, 
   3.7202109904667387`*^9}, {3.7697390583121786`*^9, 
   3.7697390679765787`*^9}, {3.769739138091581*^9, 3.7697391386954746`*^9}, {
   3.7697392796389656`*^9, 3.769739301152871*^9}, {3.7697393695504427`*^9, 
   3.769739374170706*^9}, {3.769739586294549*^9, 3.7697395864608655`*^9}},
 CellLabel->"In[32]:=",ExpressionUUID->"97b526a4-8397-44ee-bca3-74207cdf82ad"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", "Section",ExpressionUUID->"1d964aff-3d18-4ba8-81cc-221ea29e2078"],

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\[IndentingNewLine]", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.591486801989799*^9, 3.5914868026208353`*^9}},
 CellLabel->"In[37]:=",ExpressionUUID->"a100829e-e148-4b7b-ad64-278794228295"]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
WindowSize->{1373, 1505},
WindowMargins->{{Automatic, 0}, {0, Automatic}},
FrontEndVersion->"11.3 for Linux x86 (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 2943, 57, 584, "Code",ExpressionUUID->"59f5aa58-c7ae-458c-ae67-8abe32970981",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[3526, 81, 160, 3, 95, "Section",ExpressionUUID->"04ab2fc5-9b64-4da9-9a70-e61022bce381"],
Cell[3689, 86, 1890, 30, 102, "Input",ExpressionUUID->"d87f4dd9-db65-4e30-b098-18ed02ae01d7",
 InitializationCell->True],
Cell[5582, 118, 7063, 127, 582, "Input",ExpressionUUID->"7f674f35-5bdb-4c7a-a973-7a869a2c8730",
 InitializationCell->True],
Cell[12648, 247, 8267, 150, 782, "Input",ExpressionUUID->"49cfc31d-69f0-4f2b-9ad5-76cfe8f18c5c",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[20952, 402, 222, 4, 95, "Section",ExpressionUUID->"8278f024-1335-4385-9af0-6f7198297bb9"],
Cell[21177, 408, 4994, 100, 558, "Input",ExpressionUUID->"a8e7d36b-be75-452d-852f-ddcaacdf720b",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[26208, 513, 235, 4, 95, "Section",ExpressionUUID->"3d54113b-9519-4a08-b31d-5f7e1a407f10"],
Cell[26446, 519, 17021, 342, 2302, "Input",ExpressionUUID->"31edee34-209f-48d8-8c6f-7d5a7f090bfa",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[43504, 866, 222, 4, 95, "Section",ExpressionUUID->"0c24cb1d-bb29-454f-9ea3-074267fe3a8f"],
Cell[43729, 872, 422, 9, 92, "Text",ExpressionUUID->"fd4f07c2-f162-4758-a4b3-c51afea31a80"],
Cell[44154, 883, 17377, 311, 2062, "Input",ExpressionUUID->"447fbcf5-bc18-4fb4-8d21-cc65c7f71170",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[61556, 1198, 267, 4, 74, "Subsection",ExpressionUUID->"faec4d56-5fb4-4ac1-81fa-57c2dce0ca06"],
Cell[61826, 1204, 19681, 461, 3408, "Input",ExpressionUUID->"97b526a4-8397-44ee-bca3-74207cdf82ad",
 InitializationCell->True]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[81556, 1671, 85, 0, 95, "Section",ExpressionUUID->"1d964aff-3d18-4ba8-81cc-221ea29e2078"],
Cell[81644, 1673, 286, 5, 102, "Input",ExpressionUUID->"a100829e-e148-4b7b-ad64-278794228295",
 InitializationCell->True]
}, Open  ]]
}
]
*)

